# 数据传输中的分片问题

我们从一次 路由层(ip) , 传输层(udp/tcp) 来分析数据的分片问题，以及 为什么避免数据分片 和 如何避免数据分片


## 1. ip包的数据分片和重组

ip 层的主要任务是路由选择，如何找到一个路径把数转移过去，不可靠传输。

### 1.1 MMTU

ip传输的单位是包，这个包的大小受物理设备的限制。每个物理设备有自己的传输上限 MTU， 一个链路上处于瓶颈的那个 MTU 就是改路径的最大 MTU。

MTU 的发现过程

  总的来说就是源端不断重试的过程，源端发送一个ip包，标记为不可分片。如果中间有设备的 MTU 要比这个小，那中间这个设备就丢弃这个包，同时发送ICMP消息(Internet Control Message Protocol) 通知源端设备；然后源端设备使用新的 MTU 再次发送，直到 IP 数据包到达目标机器

拿以太网为例，其 MTU 一般是 1500 字节， 去掉IP头部占用的 20 字节， 实际的 payload 就是 1480 字节。如果大于这个数值，那IP层就要对其进行分片传输。问题来了，如果分片了，那什么时机在哪里重组。根据 tcp/ip 卷 1 的描述

>When an IP datagram is fragmented, it is not reassembled until it reaches its final destination. (This handling of reassembly differs from some other networking protocols that require reassembly to take place at the next hop, not at the final destination.)

目的端才会对数据进行重组，一是重组会影响传输速度； 二是重组之后可能还要分片。

### 1.2 MTU 对IP分片的影响

具体的分片过程， 以UDP为例：
    比如一段纯数据大小是2000字节， 在一般以太网(MTU=1500b)中传输时，会有如下两个分片:

                    |         ip_payload         |

        | ip_header | udp_header | udp_payload_1 |
        | ip_header | udp_payload_2 |

    20 字节 IP 协议头 + 8 字节 UDP 协议头 + 1472 字节数据；
    20 字节 IP 协议头 + 528 字节数据；

注意 分片的时候，IP包会把ip_header 之后的数据都算作是payload。所以

1. 如果第二个IP分片丢了，那无法对整个UDP重组

2. 如果ip数据包的分片太多，那不稳定性也会增加

所以因为如上原因，上层协议(传输层) 就需要考虑IP层的MTU限制，以保证传输效率和稳定性


## 2. TCP MSS (Maximum segment size), 最大分段大小

上层看 TCP 是字节流方式传输，因为上层可能交给 TCP 很多数据连续发送，TCP会分成多个 segment 进行传输。

(TCP 是建立在不稳定传输的IP层上的协议，它的目的是提供稳定的传输。办法就是 接受确认 和 重传机制)

如下图所示，假设TCP要传输的数据有2000 字节， 而MSS是1460字节，那可能会分成如下两个 segment 

        | ip_header | tcp_header |      tcp_payload_1       |
        | ip_header | tcp_header | tcp_payload_2 |

    20 字节 IP 头 + 20 字节 TCP 头 + 1460 字节数据；
    20 字节 IP 头 + 20 字节 TCP 头 + 540 字节数据；

注意 IP 分片和 TCP 分段 的不同之处:

1. IP 分片是底层物理设备的 MTU 传输限制； TCP 分段是为了避免 IP 层的分片，换言之是为了性能和稳定性

2. IP 分片中第二片及以后的分片不会包含上层协议的部首； TCP 的每段都是一个完成的 TCP 包，中间的任何一个包丢了都是可以重传的

需要注意的是，这里的segment并不是包的概念，也就是TCP认为数据是源源不断的字节流，于是对于应用层来说，本来是两个逻辑的数据可能混在同一个segment里边，而且 TCP 在重组这些 segment后，也是连续的字节流，于是就有了下边粘包的问题


## 3. TCP 的粘包问题

有了上边的分析，粘包问题，是在使用 TCP 时，应用层协议设计的问题。所以解决粘包，在设计协议时可以考虑：

1. 固定长度，协议的长度是固定的，不同业务的消息都有固定长度

2. 协议头，协议头中给定了数据的长度，接受方可以以此来对数据进行重组和分割